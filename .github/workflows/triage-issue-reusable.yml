name: "Reusable Issue Triage"

on:
  workflow_call:
    inputs:
      issue_numbers:
        description: 'JSON array of issue numbers to triage'
        required: true
        type: string
      target_repo_owner:
        description: 'Owner of the repository containing the issues'
        required: false
        type: string
        default: ''
      target_repo_name:
        description: 'Name of the repository containing the issues'
        required: false
        type: string
        default: ''
    secrets:
      SLACK_WEBHOOK_URL:
        required: false

permissions:
  issues: write
  contents: read
  actions: read
  models: read

jobs:
  triage-issues:
    if: inputs.issue_numbers != '[]' && inputs.issue_numbers != ''
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        issue_number: ${{ fromJson(inputs.issue_numbers) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get Issue Details
        id: get-issue
        uses: actions/github-script@v7
        env:
          TARGET_OWNER: ${{ inputs.target_repo_owner }}
          TARGET_REPO: ${{ inputs.target_repo_name }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { getIssueDetails } = require('./.github/scripts/get-issues.js');

            // Use target repo if specified, otherwise use current repo
            const owner = process.env.TARGET_OWNER || context.repo.owner;
            const repo = process.env.TARGET_REPO || context.repo.repo;

            const { data: issue } = await github.rest.issues.get({
              owner: owner,
              repo: repo,
              issue_number: ${{ matrix.issue_number }},
            });

            core.setOutput('issue_number', issue.number);
            core.setOutput('issue_title', issue.title);
            core.setOutput('issue_body', issue.body || '');
            core.setOutput('issue_url', issue.html_url);
            core.setOutput('repo_name', repo);

      - name: AI Issue Assessment
        id: ai-assessment
        uses: github/ai-assessment-comment-labeler@v1.0.1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue_number: ${{ steps.get-issue.outputs.issue_number }}
          issue_body: ${{ steps.get-issue.outputs.issue_body }}
          repo_name: ${{ steps.get-issue.outputs.repo_name }}
          owner: ${{ inputs.target_repo_owner || github.repository_owner }}
          ai_review_label: 'kind/bug'
          prompts_directory: './.github/prompts'
          labels_to_prompts_mapping: 'kind/bug,bug-triage.prompt.yml'
          model: 'github/gpt-4o'
          max_tokens: 300

      - name: Add kind/bug label
        if: always() && (inputs.target_repo_owner == '' || inputs.target_repo_owner == github.repository_owner)
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { addLabel } = require('./.github/scripts/add-label.js');
            await addLabel(github, context, core, ${{ steps.get-issue.outputs.issue_number }});

      - name: Process Assessments
        id: process-assessments
        if: always()
        uses: actions/github-script@v7
        env:
          ASSESSMENT_OUTPUT: ${{ steps.ai-assessment.outputs.ai_assessments }}
          ISSUE_NUMBER: ${{ steps.get-issue.outputs.issue_number }}
          ISSUE_TITLE: ${{ steps.get-issue.outputs.issue_title }}
          ISSUE_URL: ${{ steps.get-issue.outputs.issue_url }}
        with:
          script: |
            const { processAssessments } = require('./.github/scripts/process-assessments.js');
            await processAssessments(
              process.env.ASSESSMENT_OUTPUT,
              process.env.ISSUE_NUMBER,
              process.env.ISSUE_TITLE,
              process.env.ISSUE_URL,
              core
            );

      - name: Format Message for Slack
        id: format-slack
        if: always()
        uses: actions/github-script@v7
        env:
          ASSESSMENT_OUTPUT: ${{ steps.ai-assessment.outputs.ai_assessments }}
          ISSUE_NUMBER: ${{ steps.get-issue.outputs.issue_number }}
          ISSUE_TITLE: ${{ steps.get-issue.outputs.issue_title }}
          ISSUE_URL: ${{ steps.get-issue.outputs.issue_url }}
        with:
          script: |
            const { formatAssessmentForSlack } = require('./.github/scripts/format-slack-message.js');
            await formatAssessmentForSlack(
              process.env.ASSESSMENT_OUTPUT,
              process.env.ISSUE_NUMBER,
              process.env.ISSUE_TITLE,
              process.env.ISSUE_URL,
              core
            );

      - name: Send to Slack
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          ASSESSMENT_OUTPUT: ${{ steps.ai-assessment.outputs.ai_assessments }}
          ISSUE_NUMBER: ${{ steps.get-issue.outputs.issue_number }}
          ISSUE_TITLE: ${{ steps.get-issue.outputs.issue_title }}
          ISSUE_URL: ${{ steps.get-issue.outputs.issue_url }}
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            const { sendSlackMessage } = require('./.github/scripts/send-slack-message.js');
            await sendSlackMessage(
              process.env.ISSUE_NUMBER,
              process.env.ISSUE_TITLE,
              process.env.ISSUE_URL,
              process.env.ASSESSMENT_OUTPUT,
              process.env.SLACK_WEBHOOK_URL,
              core
            );
