name: "Manual Issue Triage"
run-name: "AI Triage for Recent Issues (Manual)"

on:
  workflow_dispatch:
    inputs:
      num_issues:
        description: 'Number of recent issues to triage'
        required: false
        default: '2'
        type: string

concurrency:
  group: ai-triage-manual
  cancel-in-progress: false

permissions:
  issues: write
  contents: read

jobs:
  get-recent-issues:
    runs-on: ubuntu-latest
    outputs:
      issue_numbers: ${{ steps.get-issues.outputs.issue_numbers || '[]' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get Recent Issues
        id: get-issues
        uses: actions/github-script@v7
        env:
          NUM_ISSUES: ${{ inputs.num_issues }}
        with:
          script: |
            const numIssues = parseInt(process.env.NUM_ISSUES) || 2;

            const { data: allIssues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              sort: 'created',
              direction: 'desc',
              per_page: numIssues,
            });

            // Filter out pull requests
            const issues = allIssues.filter(issue => !issue.pull_request);

            if (issues.length === 0) {
              core.info('No issues found to triage');
              core.setOutput('issue_numbers', '[]');
            } else {
              const issueNumbers = issues.map(issue => issue.number);
              core.setOutput('issue_numbers', JSON.stringify(issueNumbers));
              core.info(`Processing ${issueNumbers.length} issue(s): ${issueNumbers.join(', ')}`);
            }

  triage:
    needs: [get-recent-issues]
    if: needs.get-recent-issues.outputs.issue_numbers != '[]' && needs.get-recent-issues.outputs.issue_numbers != ''
    uses: ./.github/workflows/triage-issue-reusable.yml
    with:
      issue_numbers: ${{ needs.get-recent-issues.outputs.issue_numbers }}
    secrets:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
