name: "Triage Recent Issues"
run-name: "AI Triage for 2 Most Recent Issues"

on:
  schedule:
    # Run every day at 9:00 AM UTC
    - cron: '0 9 * * *'
  workflow_dispatch:

concurrency:
  group: ai-triage-manual
  cancel-in-progress: false

permissions:
  issues: write
  contents: read
  actions: read
  models: read

jobs:
  get-recent-issues:
    runs-on: ubuntu-latest
    outputs:
      issue_numbers: ${{ steps.get-issues.outputs.issue_numbers || '[]' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get Recent Issues
        id: get-issues
        uses: actions/github-script@v7
        with:
          script: |
            const numIssues = 2;

            const { data: allIssues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              sort: 'created',
              direction: 'desc',
              per_page: numIssues,
            });

            // Filter out pull requests
            const issues = allIssues.filter(issue => !issue.pull_request);

            if (issues.length === 0) {
              core.info('No issues found to triage');
              core.setOutput('issue_numbers', '[]');
            } else {
              const issueNumbers = issues.map(issue => issue.number);
              core.setOutput('issue_numbers', JSON.stringify(issueNumbers));
              core.info(`Processing ${issueNumbers.length} issue(s): ${issueNumbers.join(', ')}`);
            }

  triage:
    needs: [get-recent-issues]
    if: needs.get-recent-issues.outputs.issue_numbers != '[]' && needs.get-recent-issues.outputs.issue_numbers != ''
    uses: ./.github/workflows/triage-issue-reusable.yml
    with:
      issue_numbers: ${{ needs.get-recent-issues.outputs.issue_numbers }}
    secrets:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
