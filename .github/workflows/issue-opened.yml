name: "Triage New Issue"
run-name: "AI Triage for Issue #${{ github.event.issue.number }}"

on:
  issues:
    types: [opened, edited]

concurrency:
  group: ai-triage-issue-${{ github.event.issue.number }}
  cancel-in-progress: false

permissions:
  issues: write
  contents: read
  actions: read
  models: read

jobs:
  triage-issues:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Load and Prepare Prompt
        id: load-prompt
        run: |
          # Load the prompt file
          PROMPT=$(cat .github/prompts/duplicate-check.prompt.txt)
          # Replace GitHub template variables with actual values
          # Escape $ and { } for sed, use # as delimiter to avoid conflicts
          REPO_VALUE="${{ github.repository }}"
          ISSUE_NUM="${{ github.event.issue.number }}"
          PROMPT=$(echo "$PROMPT" | sed "s#\$\{\{ github.repository \}\}#${REPO_VALUE}#g")
          PROMPT=$(echo "$PROMPT" | sed "s#\$\{\{ github.event.issue.number \}\}#${ISSUE_NUM}#g")
          # Output the prompt for use in next step
          {
            echo 'prompt<<EOF'
            echo "$PROMPT"
            echo 'EOF'
          } >> $GITHUB_OUTPUT

      - name: Check for Duplicate Issues
        id: duplicate-check
        uses: google-github-actions/run-gemini-cli@v0
        continue-on-error: true
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          settings: |
            {
              "mcpServers": {
                "github": {
                  "command": "npx",
                  "args": [
                    "-y",
                    "@modelcontextprotocol/server-github"
                  ],
                  "env": {
                    "GITHUB_PERSONAL_ACCESS_TOKEN": "${{ secrets.GITHUB_TOKEN }}"
                  }
                }
              }
            }
          prompt: ${{ steps.load-prompt.outputs.prompt }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify Issue Still Open
        id: verify-issue-open
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            const isOpen = issue.data.state === 'open';
            core.setOutput('is_open', isOpen);
            core.setOutput('issue_number', issue.data.number.toString());
            core.setOutput('issue_title', issue.data.title);
            core.setOutput('issue_body', issue.data.body || '');
            core.setOutput('issue_url', issue.data.html_url);
            core.setOutput('repo_name', context.repo.repo);

            // If issue was closed (possibly by duplicate-check), log it
            if (!isOpen) {
              core.info(`Issue #${issue.data.number} is closed. Skipping triage steps.`);
            }

      - name: AI Issue Assessment
        if: steps.verify-issue-open.outcome == 'success' && steps.verify-issue-open.outputs.is_open == 'true'
        id: ai-assessment
        uses: github/ai-assessment-comment-labeler@v1.0.1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue_number: ${{ steps.verify-issue-open.outputs.issue_number }}
          issue_body: ${{ steps.verify-issue-open.outputs.issue_body }}
          repo_name: ${{ steps.verify-issue-open.outputs.repo_name }}
          owner: ${{ github.repository_owner }}
          ai_review_label: 'kind/bug'
          prompts_directory: './.github/prompts'
          labels_to_prompts_mapping: 'kind/bug,bug-triage.prompt.yml'
          max_tokens: 300

      - name: Add kind/bug label
        if: steps.verify-issue-open.outcome == 'success' && steps.verify-issue-open.outputs.is_open == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { addLabel } = require('./.github/scripts/add-label.js');
            // Use issue number from context (more reliable than step outputs)
            await addLabel(github, context, core, context.issue.number);

      - name: Process Assessments
        id: process-assessments
        if: steps.verify-issue-open.outcome == 'success' && steps.verify-issue-open.outputs.is_open == 'true' && steps.ai-assessment.outcome == 'success'
        uses: actions/github-script@v7
        env:
          ASSESSMENT_OUTPUT: ${{ steps.ai-assessment.outputs.ai_assessments }}
          ISSUE_NUMBER: ${{ steps.verify-issue-open.outputs.issue_number }}
          ISSUE_TITLE: ${{ steps.verify-issue-open.outputs.issue_title }}
          ISSUE_URL: ${{ steps.verify-issue-open.outputs.issue_url }}
        with:
          script: |
            const { processAssessments } = require('./.github/scripts/process-assessments.js');
            await processAssessments(
              process.env.ASSESSMENT_OUTPUT,
              process.env.ISSUE_NUMBER,
              process.env.ISSUE_TITLE,
              process.env.ISSUE_URL,
              core
            );

      - name: Send to Slack
        if: steps.verify-issue-open.outcome == 'success' && steps.verify-issue-open.outputs.is_open == 'true'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          ASSESSMENT_OUTPUT: ${{ steps.ai-assessment.outputs.ai_assessments || '' }}
          ISSUE_NUMBER: ${{ steps.verify-issue-open.outputs.issue_number }}
          ISSUE_TITLE: ${{ steps.verify-issue-open.outputs.issue_title }}
          ISSUE_URL: ${{ steps.verify-issue-open.outputs.issue_url }}
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            const { sendSlackMessage } = require('./.github/scripts/send-slack-message.js');
            // Only send if we have a webhook URL
            if (process.env.SLACK_WEBHOOK_URL) {
            await sendSlackMessage(
              process.env.ISSUE_NUMBER,
              process.env.ISSUE_TITLE,
              process.env.ISSUE_URL,
                process.env.ASSESSMENT_OUTPUT || '',
              process.env.SLACK_WEBHOOK_URL,
              core
            );
            } else {
              core.info('SLACK_WEBHOOK_URL not set, skipping Slack notification');
            }
